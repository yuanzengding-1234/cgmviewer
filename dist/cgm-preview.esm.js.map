{"version":3,"file":"cgm-preview.esm.js","sources":["../src/cgm-preview.ts"],"sourcesContent":["export interface CGMPreviewOptions {\n  width?: number;\n  height?: number;\n  format?: 'png' | 'jpeg' | 'webp';\n  quality?: number;\n  backgroundColor?: string;\n}\n\nexport interface CGMPreviewResult {\n  dataUrl: string;\n  blob: Blob;\n  width: number;\n  height: number;\n}\n\nexport class CGMPreview {\n  private module: any = null;\n  private canvas: HTMLCanvasElement;\n  private ctx: CanvasRenderingContext2D;\n  private isInitialized = false;\n  private wasmPath: string;\n\n  constructor(wasmPath: string = './wasm/cgmparse.wasm') {\n    this.wasmPath = wasmPath;\n    this.canvas = document.createElement('canvas');\n    this.ctx = this.canvas.getContext('2d')!;\n  }\n\n  /**\n   * Initialize the CGM preview engine\n   */\n  async initialize(): Promise<void> {\n    if (this.isInitialized) return;\n\n    try {\n      // Load the WebAssembly module\n      this.module = await this.loadWasmModule();\n      this.setupWasmFunctions();\n      this.isInitialized = true;\n    } catch (error) {\n      throw new Error(`Failed to initialize CGM preview: ${error}`);\n    }\n  }\n\n  /**\n   * Convert a CGM file to an image\n   */\n  async fileToImage(file: File, options: CGMPreviewOptions = {}): Promise<CGMPreviewResult> {\n    if (!this.isInitialized) {\n      await this.initialize();\n    }\n\n    const {\n      width = 1680,\n      height = 1270,\n      format = 'png',\n      quality = 0.9,\n      backgroundColor = 'white'\n    } = options;\n\n    try {\n      // Read file as ArrayBuffer\n      const arrayBuffer = await this.readFileAsArrayBuffer(file);\n      \n      // Setup canvas\n      this.setupCanvas(width, height, backgroundColor);\n      \n      // Process CGM file\n      await this.processCGMFile(arrayBuffer);\n      \n      // Generate image\n      return this.generateImage(format, quality);\n    } catch (error) {\n      throw new Error(`Failed to convert CGM file: ${error}`);\n    }\n  }\n\n  /**\n   * Convert CGM file from URL to image\n   */\n  async urlToImage(url: string, options: CGMPreviewOptions = {}): Promise<CGMPreviewResult> {\n    try {\n      const response = await fetch(url);\n      if (!response.ok) {\n        throw new Error(`Failed to fetch CGM file: ${response.statusText}`);\n      }\n      \n      const blob = await response.blob();\n      const file = new File([blob], 'cgm-file.cgm', { type: 'application/octet-stream' });\n      \n      return this.fileToImage(file, options);\n    } catch (error) {\n      throw new Error(`Failed to load CGM from URL: ${error}`);\n    }\n  }\n\n  private async loadWasmModule(): Promise<any> {\n    // This would need to be adapted based on how the WASM module is built\n    // For now, we'll assume it's available globally or needs to be loaded\n    return new Promise((resolve, reject) => {\n      const script = document.createElement('script');\n      script.src = this.wasmPath.replace('.wasm', '.js');\n      script.onload = () => {\n        // Assuming the module is available as a global\n        if (typeof Module !== 'undefined') {\n          resolve(Module);\n        } else {\n          reject(new Error('WASM module not found'));\n        }\n      };\n      script.onerror = () => reject(new Error('Failed to load WASM module'));\n      document.head.appendChild(script);\n    });\n  }\n\n  private setupWasmFunctions(): void {\n    // Setup WASM function bindings based on the original code\n    this.module.sdi_printcgm = this.module.cwrap('sdi_printcgm', 'number', \n      ['number', 'number', 'number', 'number', 'number', 'number']);\n    this.module.set_screen_dimensions = this.module.cwrap('set_screen_dimensions', 'number', \n      ['number', 'number']);\n    this.module.wasm_set_viewport = this.module.cwrap('wasm_set_viewport', 'number', \n      ['number', 'number', 'number', 'number']);\n    this.module.sdi_set_picture = this.module.cwrap('sdi_set_picture', 'number', ['number']);\n    this.module.set_fit_transform = this.module.cwrap('set_fit_transform', 'number', \n      ['number', 'number']);\n    this.module.getvdcX = this.module.cwrap('getvdcX', 'number', ['number', 'number']);\n    this.module.getvdcY = this.module.cwrap('getvdcY', 'number', ['number', 'number']);\n  }\n\n  private setupCanvas(width: number, height: number, backgroundColor: string): void {\n    this.canvas.width = width;\n    this.canvas.height = height;\n    \n    // Set background\n    this.ctx.fillStyle = backgroundColor;\n    this.ctx.fillRect(0, 0, width, height);\n    \n    // Setup transformation matrix similar to original code\n    this.ctx.setTransform(1, 0, 0, 1, 0, 0);\n    this.ctx.scale(0.1, 0.1);\n  }\n\n  private async readFileAsArrayBuffer(file: File): Promise<ArrayBuffer> {\n    return new Promise((resolve, reject) => {\n      const reader = new FileReader();\n      reader.onload = () => resolve(reader.result as ArrayBuffer);\n      reader.onerror = () => reject(reader.error);\n      reader.readAsArrayBuffer(file);\n    });\n  }\n\n  private async processCGMFile(arrayBuffer: ArrayBuffer): Promise<void> {\n    const uint8Array = new Uint8Array(arrayBuffer);\n    const size = uint8Array.length;\n    \n    // Allocate memory in WASM\n    const ptr = this.module._malloc(size);\n    this.module.HEAP8.set(uint8Array, ptr);\n    \n    try {\n      // Setup screen dimensions\n      const screenWidth = this.canvas.width * 10;\n      const screenHeight = this.canvas.height * 10;\n      this.module.set_screen_dimensions(screenWidth, screenHeight);\n      \n      // Set picture mode\n      this.module.sdi_set_picture(1);\n      \n      // Set fit transform\n      this.module.set_fit_transform(10000, 10000);\n      \n      // Process the CGM file\n      const status = this.module.sdi_printcgm(ptr, size, 0, 0, 0, 1);\n      \n      if (status !== 0) {\n        throw new Error(`CGM processing failed with status: ${status}`);\n      }\n    } finally {\n      // Free allocated memory\n      this.module._free(ptr);\n    }\n  }\n\n  private generateImage(format: string, quality: number): CGMPreviewResult {\n    const mimeType = `image/${format}`;\n    const dataUrl = this.canvas.toDataURL(mimeType, quality);\n    \n    // Convert to blob\n    return new Promise((resolve) => {\n      this.canvas.toBlob((blob) => {\n        resolve({\n          dataUrl,\n          blob: blob!,\n          width: this.canvas.width,\n          height: this.canvas.height\n        });\n      }, mimeType, quality);\n    }) as any; // Type assertion for simplicity\n  }\n\n  /**\n   * Cleanup resources\n   */\n  dispose(): void {\n    this.canvas.remove();\n    this.isInitialized = false;\n  }\n}\n\n// Export convenience function\nexport async function cgmToImage(\n  file: File, \n  options: CGMPreviewOptions = {}\n): Promise<CGMPreviewResult> {\n  const preview = new CGMPreview();\n  try {\n    return await preview.fileToImage(file, options);\n  } finally {\n    preview.dispose();\n  }\n}"],"names":[],"mappings":"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"}